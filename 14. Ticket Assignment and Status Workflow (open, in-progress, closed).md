## 14 â€” Ticket Assignment & Status Workflow (open, in-progress, closed)

**Goal:** Implement a simple, safe workflow so staff agents can **assign tickets** and change their **status** (Open â†’ In Progress â†’ Closed). We'll add UI for assignment, status-change buttons, permission checks (staff-only actions), admin bulk actions, and tests.

---

### ðŸ”¹ Step 1 â€” Add helper methods and properties to the `Ticket` model

Open `helpdesk/models.py` and add small helper methods to make status transitions explicit and reusable:

```python
# inside Ticket model (helpdesk/models.py)

def is_open(self):
    return self.status == self.STATUS_OPEN

def is_in_progress(self):
    return self.status == self.STATUS_IN_PROGRESS

def is_closed(self):
    return self.status == self.STATUS_CLOSED

def assign_to(self, user):
    """Assign ticket to a user (can be staff)."""
    self.assigned_to = user
    # optionally move to in_progress when assigned
    if self.is_open():
        self.status = self.STATUS_IN_PROGRESS
    self.save(update_fields=['assigned_to', 'status', 'updated_at'])

def mark_closed(self):
    self.status = self.STATUS_CLOSED
    self.save(update_fields=['status', 'updated_at'])
```

**Why:** Small model helpers keep business logic in one place and make views/tests cleaner.

---

### ðŸ”¹ Step 2 â€” Create a simple `AssignForm` and a `ChangeStatusForm`

Create or update `helpdesk/forms.py`:

```python
from django import forms
from django.contrib.auth.models import User
from .models import Ticket

class AssignForm(forms.Form):
    assignee = forms.ModelChoiceField(
        queryset=User.objects.filter(is_active=True),
        required=True,
        help_text="Select a user to assign this ticket to."
    )

class ChangeStatusForm(forms.Form):
    status = forms.ChoiceField(choices=Ticket.STATUS_CHOICES)
```

**Note:** Later you can restrict `assignee` queryset to staff agents (`user.profile.is_staff_agent`) if you want only agents to be assignable.

---

### ðŸ”¹ Step 3 â€” Add views to assign and change status (staff-only)

Update `helpdesk/views.py` with two views. Use Djangoâ€™s `user_passes_test` or `@login_required` + permission checks to allow only staff agents to perform these actions.

```python
from django.contrib.auth.decorators import login_required, user_passes_test
from django.shortcuts import get_object_or_404
from django.contrib import messages
from django.urls import reverse

def is_agent(user):
    # fallback: superusers are also considered agents
    return getattr(user, "is_superuser", False) or getattr(getattr(user, "profile", None), "is_staff_agent", False)

@login_required
@user_passes_test(is_agent)
def assign_ticket_view(request, pk):
    ticket = get_object_or_404(Ticket, pk=pk)
    if request.method == "POST":
        form = AssignForm(request.POST)
        if form.is_valid():
            assignee = form.cleaned_data['assignee']
            ticket.assign_to(assignee)
            messages.success(request, f"Ticket assigned to {assignee.username} and set to In Progress.")
            return redirect('ticket_detail', pk=pk)
    else:
        form = AssignForm()
    return render(request, 'helpdesk/assign_ticket.html', {'form': form, 'ticket': ticket})

@login_required
@user_passes_test(is_agent)
def change_status_view(request, pk):
    ticket = get_object_or_404(Ticket, pk=pk)
    if request.method == "POST":
        form = ChangeStatusForm(request.POST)
        if form.is_valid():
            new_status = form.cleaned_data['status']
            ticket.status = new_status
            ticket.save(update_fields=['status', 'updated_at'])
            messages.success(request, f"Ticket status updated to {ticket.get_status_display()}.")
            return redirect('ticket_detail', pk=pk)
    else:
        form = ChangeStatusForm(initial={'status': ticket.status})
    return render(request, 'helpdesk/change_status.html', {'form': form, 'ticket': ticket})
```

**Why:** `user_passes_test(is_agent)` keeps assignment/status changes limited to authorized staff.

---

### ðŸ”¹ Step 4 â€” Add URLs and Templates for assignment/status UI

**URLs** â€” update `helpdesk/urls.py`:

```python
path('tickets/<int:pk>/assign/', views.assign_ticket_view, name='ticket_assign'),
path('tickets/<int:pk>/status/', views.change_status_view, name='ticket_change_status'),
```

**Templates** â€” create `templates/helpdesk/assign_ticket.html`:

```html
{% extends 'helpdesk/base.html' %}
{% block content %}
<div class="card">
  <div class="card-body">
    <h4>Assign Ticket: {{ ticket.title }}</h4>
    <form method="post">
      {% csrf_token %}
      {{ form.as_p }}
      <button type="submit" class="btn btn-primary">Assign</button>
      <a href="{% url 'ticket_detail' ticket.pk %}" class="btn btn-secondary">Cancel</a>
    </form>
  </div>
</div>
{% endblock %}
```

And `templates/helpdesk/change_status.html`:

```html
{% extends 'helpdesk/base.html' %}
{% block content %}
<div class="card">
  <div class="card-body">
    <h4>Change Status: {{ ticket.title }}</h4>
    <form method="post">
      {% csrf_token %}
      {{ form.as_p }}
      <button type="submit" class="btn btn-warning">Update Status</button>
      <a href="{% url 'ticket_detail' ticket.pk %}" class="btn btn-secondary">Cancel</a>
    </form>
  </div>
</div>
{% endblock %}
```

**Small UX addition (ticket detail):** Edit `ticket_detail.html` to show action buttons only for agents:

```html
{% if user|has_attr:"profile" and (user.is_superuser or user.profile.is_staff_agent) %}
  <a href="{% url 'ticket_assign' ticket.pk %}" class="btn btn-sm btn-outline-primary">Assign</a>
  <a href="{% url 'ticket_change_status' ticket.pk %}" class="btn btn-sm btn-outline-warning">Change Status</a>
{% endif %}
```

*(If your template language doesn't have `has_attr`, just catch exceptions or use `user.is_superuser or user.profile.is_staff_agent`.)*

---

### ðŸ”¹ Step 5 â€” Admin bulk actions, tests, and commit

**Admin bulk actions** â€” we added similar actions earlier; ensure they exist in `helpdesk/admin.py`:

```python
def mark_as_closed(self, request, queryset):
    count = queryset.update(status=Ticket.STATUS_CLOSED)
    self.message_user(request, f"{count} ticket(s) marked as Closed.")
```

You can also add `assign_to_user` admin action later for bulk assignment.

**Tests** â€” add tests to `helpdesk/tests.py`:

```python
class AssignmentWorkflowTest(TestCase):
    def setUp(self):
        self.agent = User.objects.create_user('agent', password='pw')
        UserProfile.objects.create(user=self.agent, is_staff_agent=True)
        self.user = User.objects.create_user('alice', password='pw')
        self.ticket = Ticket.objects.create(title="t", description="d", created_by=self.user)

    def test_agent_can_assign(self):
        self.client.login(username='agent', password='pw')
        resp = self.client.post(reverse('ticket_assign', args=[self.ticket.pk]), {
            'assignee': self.agent.pk
        }, follow=True)
        self.ticket.refresh_from_db()
        self.assertEqual(self.ticket.assigned_to, self.agent)
        self.assertEqual(self.ticket.status, Ticket.STATUS_IN_PROGRESS)

    def test_non_agent_cannot_assign(self):
        self.client.login(username='alice', password='pw')
        resp = self.client.get(reverse('ticket_assign', args=[self.ticket.pk]))
        self.assertEqual(resp.status_code, 403)  # forbidden
```

Run tests:

```bash
python manage.py test helpdesk
```

**Commit & push:**

```bash
git add helpdesk/models.py helpdesk/forms.py helpdesk/views.py helpdesk/urls.py templates/helpdesk/assign_ticket.html templates/helpdesk/change_status.html helpdesk/tests.py
git commit -m "Add ticket assignment and status-change workflow with staff-only checks and tests"
git push origin main
```
