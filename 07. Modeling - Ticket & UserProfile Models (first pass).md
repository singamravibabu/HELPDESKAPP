## 7 â€” Modeling: Ticket & UserProfile Models (first pass)

**Goal:** Create the first data models for the Helpdesk: a `Ticket` model and a `UserProfile` model (extending Djangoâ€™s `User`). Run migrations, register them in admin, and test basic creation. Simple, practical, and ready for the next lessons.

---

### ðŸ”¹ Step 1 â€” Add models to `helpdesk/models.py`

Open `helpdesk/models.py` and replace or add the following code:

```python
from django.db import models
from django.contrib.auth.models import User
from django.utils import timezone

class UserProfile(models.Model):
    """Simple profile extension for Django's User."""
    user = models.OneToOneField(User, on_delete=models.CASCADE, related_name="profile")
    phone = models.CharField(max_length=20, blank=True)
    is_staff_agent = models.BooleanField(default=False)  # mark support agents

    def __str__(self):
        return f"{self.user.username} Profile"

class Ticket(models.Model):
    STATUS_OPEN = "open"
    STATUS_IN_PROGRESS = "in_progress"
    STATUS_CLOSED = "closed"
    STATUS_CHOICES = [
        (STATUS_OPEN, "Open"),
        (STATUS_IN_PROGRESS, "In Progress"),
        (STATUS_CLOSED, "Closed"),
    ]

    PRIORITY_LOW = "low"
    PRIORITY_MEDIUM = "medium"
    PRIORITY_HIGH = "high"
    PRIORITY_CHOICES = [
        (PRIORITY_LOW, "Low"),
        (PRIORITY_MEDIUM, "Medium"),
        (PRIORITY_HIGH, "High"),
    ]

    title = models.CharField(max_length=200)
    description = models.TextField()
    created_by = models.ForeignKey(User, on_delete=models.CASCADE, related_name="tickets_created")
    assigned_to = models.ForeignKey(User, null=True, blank=True, on_delete=models.SET_NULL, related_name="tickets_assigned")
    status = models.CharField(max_length=20, choices=STATUS_CHOICES, default=STATUS_OPEN)
    priority = models.CharField(max_length=10, choices=PRIORITY_CHOICES, default=PRIORITY_MEDIUM)
    created_at = models.DateTimeField(default=timezone.now)
    updated_at = models.DateTimeField(auto_now=True)

    def __str__(self):
        return f"[{self.get_status_display()}] {self.title}"
```

Save the file.

---

### ðŸ”¹ Step 2 â€” Create & run migrations

In the terminal (ensure your virtualenv is activated and you are in the project root):

```bash
python manage.py makemigrations helpdesk
python manage.py migrate
```

âœ… Expected outcome:

* `makemigrations` creates migration files under `helpdesk/migrations/`
* `migrate` applies them to the SQLite DB (creates `helpdesk_userprofile` and `helpdesk_ticket` tables)

If you see errors, read the traceback â€” it usually points to a typo or missing import.

---

### ðŸ”¹ Step 3 â€” Register models in Django Admin

Open `helpdesk/admin.py` and add registration so you can view/manage these models in the admin UI:

```python
from django.contrib import admin
from .models import UserProfile, Ticket

@admin.register(UserProfile)
class UserProfileAdmin(admin.ModelAdmin):
    list_display = ("user", "phone", "is_staff_agent")
    search_fields = ("user__username", "user__email", "phone")

@admin.register(Ticket)
class TicketAdmin(admin.ModelAdmin):
    list_display = ("title", "status", "priority", "created_by", "assigned_to", "created_at")
    list_filter = ("status", "priority", "created_at")
    search_fields = ("title", "description", "created_by__username", "assigned_to__username")
```

Save the file.

Then create a superuser (so you can log into admin):

```bash
python manage.py createsuperuser
# follow prompts: username, email, password
```

Run the dev server:

```bash
python manage.py runserver
```

Open [http://127.0.0.1:8000/admin](http://127.0.0.1:8000/admin) and log in with your superuser â€” you should see **User profiles** and **Tickets** listed.

---

### ðŸ”¹ Step 4 â€” Quick test: create a ticket in Django shell

Open the Django shell and make one sample Ticket to confirm relationships:

```bash
python manage.py shell
```

Inside the shell:

```python
from django.contrib.auth.models import User
from helpdesk.models import Ticket, UserProfile

# get or create user
user, created = User.objects.get_or_create(username="alice", defaults={"email":"alice@example.com"})
if created:
    user.set_password("password123")
    user.save()
    profile = UserProfile.objects.create(user=user, phone="1234567890", is_staff_agent=False)

# create a ticket
ticket = Ticket.objects.create(
    title="Example: Cannot access VPN",
    description="I get an authentication error when trying to connect.",
    created_by=user
)

print(ticket.id, ticket.title, ticket.status, ticket.created_by.username)
```

Exit shell with `exit()`.

This confirms your models and DB are working.

---

### ðŸ”¹ Step 5 â€” Commit changes and push to GitHub

Keep a clean commit history. From your project root:

```bash
git add helpdesk/models.py helpdesk/admin.py
git commit -m "Add Ticket and UserProfile models; register in admin; run migrations"
git push origin main
```

(If you created migration files, also commit them:)

```bash
git add helpdesk/migrations/
git commit -m "Add initial helpdesk migrations"
git push origin main
```

âœ… Your repository now contains model code and migration files â€” good for collaboration.

---

### ðŸ§­ Summary

* Created `UserProfile` (OneToOne with `User`) and `Ticket` models with sensible fields and choices.
* Ran `makemigrations` and `migrate` to update the SQLite DB.
* Registered models in Django admin and created a superuser for testing.
* Tested model creation in the Django shell.
* Committed and pushed changes to GitHub.
