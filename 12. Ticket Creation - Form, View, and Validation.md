## 12 â€” Ticket Creation: Form, View, and Validation

**Goal:** Let authenticated users create tickets. Youâ€™ll add a `TicketForm` (a `ModelForm`), a create view, URL, template, basic validation, and a quick test. Simple and focused â€” users can submit tickets that are saved to SQLite.

---

### ðŸ”¹ Step 1 â€” Create a `TicketForm` (ModelForm)

Add a new file `helpdesk/forms.py` and create a `ModelForm` so Django handles boilerplate for you:

```python
# helpdesk/forms.py
from django import forms
from .models import Ticket

class TicketForm(forms.ModelForm):
    class Meta:
        model = Ticket
        fields = ["title", "description", "priority"]  # exclude created_by/assigned_to/status

    def clean_title(self):
        title = self.cleaned_data.get("title", "").strip()
        if len(title) < 5:
            raise forms.ValidationError("Title must be at least 5 characters.")
        return title
```

**Why:** `ModelForm` saves time and keeps form â†” model mapping consistent. The `clean_title` adds a simple validation rule.

---

### ðŸ”¹ Step 2 â€” Add the create view (with login protection)

Open `helpdesk/views.py` and add a view that requires login, uses the form, and sets `created_by` automatically:

```python
# helpdesk/views.py (add these imports at top if not present)
from django.shortcuts import render, redirect
from django.contrib.auth.decorators import login_required
from django.contrib import messages
from .forms import TicketForm

@login_required
def ticket_create_view(request):
    if request.method == "POST":
        form = TicketForm(request.POST)
        if form.is_valid():
            ticket = form.save(commit=False)
            ticket.created_by = request.user
            ticket.save()
            messages.success(request, "Ticket created successfully.")
            return redirect('ticket_detail', pk=ticket.pk)
        else:
            messages.error(request, "Please correct the errors below.")
    else:
        form = TicketForm()
    return render(request, "helpdesk/ticket_create.html", {"form": form})
```

**Why:** `commit=False` lets you set `created_by` before saving. `login_required` prevents anonymous submissions.

---

### ðŸ”¹ Step 3 â€” Add URL patterns

Edit `helpdesk/urls.py` to include create and detail URLs:

```python
from django.urls import path
from . import views

urlpatterns = [
    path('signup/', views.signup_view, name='signup'),
    path('home/', views.home_view, name='helpdesk_home'),

    # Tickets
    path('tickets/create/', views.ticket_create_view, name='ticket_create'),
    path('tickets/<int:pk>/', views.ticket_detail_view, name='ticket_detail'),
]
```

Also ensure you add a simple `ticket_detail_view` if not present so redirects work:

```python
@login_required
def ticket_detail_view(request, pk):
    from .models import Ticket
    ticket = Ticket.objects.filter(pk=pk).select_related('created_by', 'assigned_to').first()
    if not ticket:
        messages.error(request, "Ticket not found.")
        return redirect('helpdesk_home')
    return render(request, "helpdesk/ticket_detail.html", {"ticket": ticket})
```

---

### ðŸ”¹ Step 4 â€” Create templates for create + detail

Create `templates/helpdesk/ticket_create.html`:

```html
{% extends 'helpdesk/base.html' %}
{% block content %}
<div class="row justify-content-center">
  <div class="col-md-8">
    <h3>Create Ticket</h3>
    <form method="post" novalidate>
      {% csrf_token %}
      {{ form.as_p }}
      <button type="submit" class="btn btn-primary">Submit Ticket</button>
      <a href="{% url 'helpdesk_home' %}" class="btn btn-secondary">Cancel</a>
    </form>
  </div>
</div>
{% endblock %}
```

Create `templates/helpdesk/ticket_detail.html`:

```html
{% extends 'helpdesk/base.html' %}
{% block content %}
<div class="card">
  <div class="card-body">
    <h4>{{ ticket.title }}</h4>
    <p class="text-muted">Status: {{ ticket.get_status_display }} â€¢ Priority: {{ ticket.get_priority_display }}</p>
    <p>{{ ticket.description|linebreaks }}</p>
    <p class="small text-muted">Created by {{ ticket.created_by.username }} on {{ ticket.created_at }}</p>
    <a href="{% url 'helpdesk_home' %}" class="btn btn-link">Back</a>
  </div>
</div>
{% endblock %}
```

---

### ðŸ”¹ Step 5 â€” Test flow, add a simple unit test, commit & push

1. **Manual test**

   * Start server: `python manage.py runserver`
   * Login, go to: `/helpdesk/tickets/create/`
   * Fill form with a title (â‰¥5 chars), description, and priority. Submit.
   * Confirm you are redirected to ticket detail and message appears.

2. **Quick automated test** â€” add to `helpdesk/tests.py`:

```python
from django.test import TestCase
from django.contrib.auth.models import User
from django.urls import reverse

class TicketCreationTest(TestCase):
    def test_create_ticket_requires_login(self):
        resp = self.client.get(reverse('ticket_create'))
        self.assertEqual(resp.status_code, 302)  # redirected to login

    def test_create_ticket_post(self):
        u = User.objects.create_user('tester', password='pw')
        self.client.login(username='tester', password='pw')
        resp = self.client.post(reverse('ticket_create'), {
            'title': 'VPN issue',
            'description': 'Cannot connect',
            'priority': 'medium',
        }, follow=True)
        self.assertContains(resp, "Ticket created successfully.")
```

Run tests:

```bash
python manage.py test helpdesk
```

3. **Commit & push**

```bash
git add helpdesk/forms.py helpdesk/views.py helpdesk/urls.py templates/helpdesk/ticket_create.html templates/helpdesk/ticket_detail.html helpdesk/tests.py
git commit -m "Add ticket creation form, view, templates, detail view and tests"
git push origin main
```
