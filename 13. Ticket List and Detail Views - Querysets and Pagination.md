## 13 â€” Ticket List & Detail Views: Querysets and Pagination

**Goal:** Build efficient list and detail pages for tickets. Learn to use Django ORM querysets (`select_related`, filtering, ordering) and add pagination so long lists stay usable.

By the end of this lesson you'll have:

* A paginated ticket list view with basic filters (status, priority).
* An efficient ticket detail view (using `select_related`).
* Templates with pagination controls.
* A simple test and a commit workflow.

---

### ðŸ”¹ Step 1 â€” Update views: efficient querysets and pagination

Edit `helpdesk/views.py` and add a `ticket_list_view` (or update it if present). Use `select_related` to avoid extra DB queries and `Paginator` for page splits.

```python
from django.core.paginator import Paginator
from django.db.models import Q
from .models import Ticket

@login_required
def ticket_list_view(request):
    qs = Ticket.objects.select_related('created_by', 'assigned_to').order_by('-created_at')

    # Simple filters from query params: ?status=open&priority=high&q=search
    status = request.GET.get('status')
    priority = request.GET.get('priority')
    q = request.GET.get('q')

    if status:
        qs = qs.filter(status=status)
    if priority:
        qs = qs.filter(priority=priority)
    if q:
        qs = qs.filter(
            Q(title__icontains=q) |
            Q(description__icontains=q) |
            Q(created_by__username__icontains=q) |
            Q(assigned_to__username__icontains=q)
        )

    # Pagination: 10 tickets per page
    paginator = Paginator(qs, 10)
    page_number = request.GET.get('page')
    page_obj = paginator.get_page(page_number)

    context = {
        'page_obj': page_obj,
        'status': status,
        'priority': priority,
        'q': q,
    }
    return render(request, 'helpdesk/ticket_list.html', context)
```

Also ensure your `ticket_detail_view` uses `select_related` (we added that earlier, but confirm):

```python
@login_required
def ticket_detail_view(request, pk):
    ticket = Ticket.objects.select_related('created_by', 'assigned_to').filter(pk=pk).first()
    if not ticket:
        messages.error(request, "Ticket not found.")
        return redirect('ticket_list')
    return render(request, "helpdesk/ticket_detail.html", {"ticket": ticket})
```

---

### ðŸ”¹ Step 2 â€” Add URL for the list view

Edit `helpdesk/urls.py` to include the list route (and update any root redirects if needed):

```python
urlpatterns = [
    path('signup/', views.signup_view, name='signup'),
    path('home/', views.home_view, name='helpdesk_home'),

    # Tickets
    path('tickets/', views.ticket_list_view, name='ticket_list'),
    path('tickets/create/', views.ticket_create_view, name='ticket_create'),
    path('tickets/<int:pk>/', views.ticket_detail_view, name='ticket_detail'),
]
```

Optionally change the root redirect in `config/urls.py` to point to `ticket_list` (after login) or keep as-is.

---

### ðŸ”¹ Step 3 â€” Create the ticket list template with pagination controls

Create `templates/helpdesk/ticket_list.html`:

```html
{% extends 'helpdesk/base.html' %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h3>Tickets</h3>
  <a class="btn btn-primary" href="{% url 'ticket_create' %}">Create Ticket</a>
</div>

<form method="get" class="row g-2 mb-3">
  <div class="col-auto">
    <input name="q" value="{{ q|default_if_none:'' }}" class="form-control" placeholder="Search...">
  </div>
  <div class="col-auto">
    <select name="status" class="form-select">
      <option value="">All statuses</option>
      <option value="open" {% if status == 'open' %}selected{% endif %}>Open</option>
      <option value="in_progress" {% if status == 'in_progress' %}selected{% endif %}>In Progress</option>
      <option value="closed" {% if status == 'closed' %}selected{% endif %}>Closed</option>
    </select>
  </div>
  <div class="col-auto">
    <select name="priority" class="form-select">
      <option value="">All priorities</option>
      <option value="low" {% if priority == 'low' %}selected{% endif %}>Low</option>
      <option value="medium" {% if priority == 'medium' %}selected{% endif %}>Medium</option>
      <option value="high" {% if priority == 'high' %}selected{% endif %}>High</option>
    </select>
  </div>
  <div class="col-auto">
    <button class="btn btn-outline-secondary" type="submit">Filter</button>
  </div>
</form>

{% if page_obj.object_list %}
  <div class="list-group">
    {% for ticket in page_obj.object_list %}
      <a href="{% url 'ticket_detail' ticket.pk %}" class="list-group-item list-group-item-action">
        <div class="d-flex w-100 justify-content-between">
          <h5 class="mb-1">{{ ticket.title }}</h5>
          <small class="text-muted">{{ ticket.created_at|date:"Y-m-d H:i" }}</small>
        </div>
        <p class="mb-1 text-truncate">{{ ticket.description }}</p>
        <small>By {{ ticket.created_by.username }} â€¢ {{ ticket.get_priority_display }} â€¢ {{ ticket.get_status_display }}</small>
      </a>
    {% endfor %}
  </div>

  <!-- Pagination controls -->
  <nav aria-label="Ticket pagination" class="mt-3">
    <ul class="pagination">
      {% if page_obj.has_previous %}
        <li class="page-item">
          <a class="page-link" href="?{% if q %}q={{ q }}&amp;{% endif %}{% if status %}status={{ status }}&amp;{% endif %}{% if priority %}priority={{ priority }}&amp;{% endif %}page={{ page_obj.previous_page_number }}" aria-label="Previous">
            &laquo;
          </a>
        </li>
      {% else %}
        <li class="page-item disabled"><span class="page-link">&laquo;</span></li>
      {% endif %}

      {% for num in page_obj.paginator.page_range %}
        {% if page_obj.number == num %}
          <li class="page-item active"><span class="page-link">{{ num }}</span></li>
        {% elif num > page_obj.number|add:-5 and num < page_obj.number|add:5 %}
          <li class="page-item"><a class="page-link" href="?{% if q %}q={{ q }}&amp;{% endif %}{% if status %}status={{ status }}&amp;{% endif %}{% if priority %}priority={{ priority }}&amp;{% endif %}page={{ num }}">{{ num }}</a></li>
        {% endif %}
      {% endfor %}

      {% if page_obj.has_next %}
        <li class="page-item">
          <a class="page-link" href="?{% if q %}q={{ q }}&amp;{% endif %}{% if status %}status={{ status }}&amp;{% endif %}{% if priority %}priority={{ priority }}&amp;{% endif %}page={{ page_obj.next_page_number }}" aria-label="Next">
            &raquo;
          </a>
        </li>
      {% else %}
        <li class="page-item disabled"><span class="page-link">&raquo;</span></li>
      {% endif %}
    </ul>
  </nav>

{% else %}
  <p>No tickets found. <a href="{% url 'ticket_create' %}">Create one</a>.</p>
{% endif %}
{% endblock %}
```

This template preserves filter params in pagination links so the user doesnâ€™t lose filters when moving pages.

---

### ðŸ”¹ Step 4 â€” Add a basic test for list view and pagination

Append tests to `helpdesk/tests.py`:

```python
from django.urls import reverse
from .models import Ticket

class TicketListTest(TestCase):
    def setUp(self):
        self.user = User.objects.create_user('pete', password='pw')
        # create 25 tickets to ensure pagination
        for i in range(25):
            Ticket.objects.create(
                title=f"Ticket {i}",
                description="desc",
                created_by=self.user,
                priority='medium'
            )

    def test_ticket_list_requires_login(self):
        resp = self.client.get(reverse('ticket_list'))
        self.assertEqual(resp.status_code, 302)  # redirects to login

    def test_ticket_list_pagination(self):
        self.client.login(username='pete', password='pw')
        resp = self.client.get(reverse('ticket_list'))
        self.assertEqual(resp.status_code, 200)
        # default 10 per page
        self.assertContains(resp, "Ticket 0")
        self.assertTrue('page_obj' in resp.context)
        self.assertEqual(resp.context['page_obj'].paginator.num_pages, 3)
```

Run:

```bash
python manage.py test helpdesk
```

---

### ðŸ”¹ Step 5 â€” Commit, push, and manual checks

1. **Stage and commit:**

```bash
git add helpdesk/views.py helpdesk/urls.py templates/helpdesk/ticket_list.html helpdesk/tests.py
git commit -m "Add ticket list view with filters, pagination, template and tests"
git push origin main
```

2. **Manual check:**

   * Run the dev server: `python manage.py runserver`
   * Login and visit: `http://127.0.0.1:8000/helpdesk/tickets/`
   * Try filtering by status/priority, searching, and navigating pages.

