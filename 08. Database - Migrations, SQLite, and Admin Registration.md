## 8 â€” Database: Migrations, SQLite, and Admin Registration

**Goal:** Deepen your understanding of Django migrations, how SQLite (Djangoâ€™s default DB) stores data, best practices for migration workflow, enhance admin registration (list display, filters, inlines), and learn how to backup/restore and load fixtures. Simple, practical, and safe for beginners.

---

### ðŸ”¹ Step 1 â€” Review and run migrations safely

1. **See pending migrations:**

   ```bash
   python manage.py showmigrations
   ```

   This lists which apps/migrations are applied (`[X]`) or pending (`[ ]`).

2. **Create migrations after model changes:**

   ```bash
   python manage.py makemigrations
   ```

   Inspect the generated files under `helpdesk/migrations/` before applying.

3. **Apply migrations:**

   ```bash
   python manage.py migrate
   ```

4. **If something goes wrong (development only):** you can fake, unapply, or reset a migration, but do this cautiously:

   ```bash
   # unapply the latest migration for helpdesk
   python manage.py migrate helpdesk <previous_migration_name>
   ```

   Avoid destructive operations on production DBs.

5. **Commit migration files** with your code so teammates get the same DB schema:

   ```bash
   git add helpdesk/migrations/
   git commit -m "Add migrations for helpdesk models"
   git push
   ```

---

### ðŸ”¹ Step 2 â€” Understand SQLite basics & where data lives

1. **Default DB file:** Django creates the SQLite file (commonly `db.sqlite3`) at your project root (unless changed in `settings.py`).

2. **Inspecting DB (simple):**

   * Use the Django shell to query models:

     ```bash
     python manage.py shell
     >>> from helpdesk.models import Ticket
     >>> Ticket.objects.count()
     ```
   * Or use `sqlite3` CLI (optional):

     ```bash
     sqlite3 db.sqlite3
     sqlite> .tables
     sqlite> SELECT count(*) FROM helpdesk_ticket;
     ```

3. **SQLite is file-based:** good for local dev and small teams. Itâ€™s not recommended for heavy production use (but perfect for learning).

4. **Never commit the DB file** to Git. Ensure `db.sqlite3` is added to `.gitignore`. If accidentally committed, remove it from history (advanced) â€” avoid that as beginners.

5. **Locking behavior:** SQLite is simple but has limited concurrent write capabilities â€” fine for local development but keep it in mind.

---

### ðŸ”¹ Step 3 â€” Enhance Django Admin for usability

1. **Improve `helpdesk/admin.py`** (examples to paste in):

```python
from django.contrib import admin
from .models import Ticket, UserProfile

class TicketInline(admin.TabularInline):
    model = Ticket
    extra = 0
    fields = ('title', 'status', 'priority', 'assigned_to', 'created_at')
    readonly_fields = ('created_at',)

@admin.register(UserProfile)
class UserProfileAdmin(admin.ModelAdmin):
    list_display = ('user', 'phone', 'is_staff_agent')
    search_fields = ('user__username', 'user__email', 'phone')
    inlines = [TicketInline]

@admin.register(Ticket)
class TicketAdmin(admin.ModelAdmin):
    list_display = ('title', 'status', 'priority', 'created_by', 'assigned_to', 'created_at')
    list_filter = ('status', 'priority', 'created_at')
    search_fields = ('title', 'description', 'created_by__username', 'assigned_to__username')
    raw_id_fields = ('created_by', 'assigned_to')  # helpful with many users
    date_hierarchy = 'created_at'
```

2. **Restart dev server** and visit `/admin/` to see improved lists, filters, and inlines.

3. **Small admin UX tips:** use `list_display_links`, `list_editable`, and `fieldsets` later to polish forms.

4. **Test admin features** with sample data (create users, tickets) to see filters and search in action.

5. **Commit admin changes** to keep team UI consistent.

---

### ðŸ”¹ Step 4 â€” Backup, fixtures, and sample data

1. **Quick DB backup (copy file):**

   ```bash
   cp db.sqlite3 backups/db.sqlite3.bak
   ```

   Store backups outside repo.

2. **Use Django fixtures to export sample data (JSON):**

   ```bash
   # export tickets and users (careful with sensitive fields)
   python manage.py dumpdata auth.user helpdesk.ticket --indent 2 > fixtures/initial_data.json
   ```

   Add `fixtures/` to the repo (fixtures are safe to version).

3. **Load fixtures on another machine:**

   ```bash
   python manage.py loaddata fixtures/initial_data.json
   ```

4. **Create management commands or scripts** later to populate demo data (`python manage.py createsuperuser --noinput` plus `loaddata`).

5. **Do not store real passwords or secrets** in fixtures; use fake/demo accounts for sharing.

---

### ðŸ”¹ Step 5 â€” Tests, migrations in PRs, and collaboration best practices

1. **Add quick model tests** (e.g., `helpdesk/tests.py`) so migrations and models behave as expected:

   ```python
   from django.test import TestCase
   from django.contrib.auth.models import User
   from .models import Ticket

   class TicketModelTest(TestCase):
       def test_create_ticket(self):
           u = User.objects.create_user('bob', password='pw')
           t = Ticket.objects.create(title="t1", description="d", created_by=u)
           self.assertEqual(Ticket.objects.count(), 1)
   ```

2. **Run tests locally before committing:**

   ```bash
   python manage.py test
   ```

3. **When working in a team / PR workflow:**

   * Create a feature branch: `git checkout -b feature/ticket-models`
   * Add migrations & tests to the branch.
   * Push branch & open PR. Ensure migrations are included in the PR so reviewers can test locally.

4. **CI tip (later in GitHub Actions):** configure workflows to run `makemigrations --check` or at least `python manage.py test` so schema changes are caught early.

5. **Commit and push often** with clear messages (`Add Ticket model; include migrations; add admin enhancements`).
